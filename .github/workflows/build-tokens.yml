name: Build Design Tokens

on:
  push:
    paths:
      - 'packages/cfpb-design-system/src/tokens/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/cfpb-design-system/src/tokens/**'

permissions:
  contents: read

jobs:
  build_and_commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: npm install style-dictionary --force # Add other dependencies if needed

      - name: Build tokens
        run: npx style-dictionary build --config ./style-dictionary.config.js # could be improved to use installed style-dictionary

      - name: Verify generated token files
        run: |
          DIR=packages/cfpb-design-system/src/elements
          if [ ! -d "$DIR" ] || [ -z "$(ls -A "$DIR" 2>/dev/null)" ]; then
            echo "ERROR: No generated token files found in $DIR"
            ls -R packages/cfpb-design-system || true
            exit 1
          fi
          ls -la "$DIR"

      - name: DEBUG show git status (before add)
        run: |
          git rev-parse --abbrev-ref HEAD || true
          git status --porcelain --untracked-files=all || true

      - name: Stage generated files (ensure new files are included)
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git add -v packages/cfpb-design-system/src/elements/*.css || true
          git status --porcelain --untracked-files=all || true

      - name: Auto commit generated tokens
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: stefanzweifel/git-auto-commit-action@v5
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          file_pattern: 'packages/cfpb-design-system/src/elements/*.css'
          commit_message: "Automated commit: Style Dictionary â†’ CSS tokens"
          branch: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
          commit_user_name: "github-actions[bot]"